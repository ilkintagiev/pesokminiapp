<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞</title>

  <!-- Firebase SDK (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±, –±–µ–∑ –º–æ–¥—É–ª–µ–π) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"
  ></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80")
        no-repeat center fixed;
      background-size: cover;
      margin: 0;
      padding-bottom: 70px;
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .main-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .content-section {
      display: none;
      background: linear-gradient(
        135deg,
        rgba(255, 235, 200, 0.9),
        rgba(255, 255, 255, 0.8)
      );
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }
    .content-section.active {
      display: block;
    }
    .navbar-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #ffca28;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .navbar-bottom .btn {
      width: 50px;
      height: 50px;
      font-size: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff !important;
      color: #ffca28 !important;
      border: 2px solid #ffca28 !important;
      transition: transform 0.2s ease !important;
    }
    .navbar-bottom .btn:hover {
      background: #ffca28 !important;
      color: #fff !important;
      transform: scale(1.1) !important;
    }
    .navbar-bottom .btn:active {
      transform: scale(0.95) !important;
    }
    img.logo {
      max-width: 200px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      animation: neonGlow 4s ease-in-out infinite;
    }
    @keyframes neonGlow {
      0% {
        filter: drop-shadow(0 0 5px #ffca28) brightness(1);
      }
      33% {
        filter: drop-shadow(0 0 15px #00ffff) brightness(1.2);
      }
      66% {
        filter: drop-shadow(0 0 15px #00ff00) brightness(1.2);
      }
      100% {
        filter: drop-shadow(0 0 10px #e0f7ff) brightness(1.1);
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th,
    td {
      padding: 6px;
      border: 1px solid #ddd;
      text-align: left;
      word-wrap: break-word;
      max-width: 100px;
    }
    th {
      background-color: rgba(255, 245, 200, 0.9);
    }
    .black-label {
      color: #000;
      text-shadow: none;
    }
    .catalog-item img {
      max-width: 100px;
      border-radius: 5px;
    }
    .qr-container {
      margin-top: 10px;
    }
    #qrCanvas {
      display: none;
    }
    #qrVideo {
      width: 100%;
      max-width: 300px;
      border-radius: 5px;
    }
    #debugInfo {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
    .form-control:focus {
      position: relative;
      z-index: 10;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <img src="–†–µ—Å—É—Ä—Å 1@10x.png" alt="–õ–µ–π–±–ª –ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞" class="logo" />

    <!-- –°–µ–∫—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
    <div id="welcomeSection" class="content-section active">
      <h3 class="black-label">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
      <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –¥–æ—Ä–æ–≥–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–∏ –Ω–∞—à–∏—Ö –º–∞–ª–µ–Ω—å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π!</p>
      <p>
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ "–ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞" ‚Äî —É–≥–æ–ª–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏, –≥–¥–µ –¥–µ—Ç–∏
        –Ω–∞—Å–ª–∞–∂–¥–∞—é—Ç—Å—è –∏–≥—Ä–æ–π —Å –º—è–≥–∫–∏–º –±–µ–ª—ã–º –ø–µ—Å–∫–æ–º –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞! üå¥üåä
      </p>
      <p>
        –£ –Ω–∞—Å –≤–∞—à —Ä–µ–±—ë–Ω–æ–∫ –ø—Ä–æ–≤–µ–¥—ë—Ç –≤—Ä–µ–º—è —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –∏ –ø–æ–ª—å–∑–æ–π, –∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ
        —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è, –∑–Ω–∞—è, —á—Ç–æ –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–æ –¥–ª—è –µ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
      </p>
      <p>"–ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞" ‚Äî —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ —Ä–æ–∂–¥–∞—é—Ç—Å—è —É–ª—ã–±–∫–∏ –∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è!</p>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ -->
    <div id="broadcastSection" class="content-section">
      <h3 class="black-label">–í–∏–¥–µ–æ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è</h3>
      <p>
        –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É Telegram-–∫–∞–Ω–∞–ª—É, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é –≤
        —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!
      </p>
      <button
        class="btn btn-warning w-75 mt-3"
        onclick="window.open('https://t.me/pesok_86', '_blank')"
      >
        <i class="fas fa-video"></i> –°–º–æ—Ç—Ä–µ—Ç—å –≤ Telegram
      </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –≤—Ö–æ–¥ -->
    <div id="adminLoginSection" class="content-section">
      <h3 class="black-label">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
      <input
        type="password"
        class="form-control"
        id="adminPassword"
        placeholder="–ü–∞—Ä–æ–ª—å"
      />
      <button class="btn btn-primary w-100 mt-2" onclick="adminLogin()">
        –í–æ–π—Ç–∏
      </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –ø–∞–Ω–µ–ª—å -->
    <div id="adminPanelSection" class="content-section">
      <h3 class="black-label">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
      <button
        class="btn btn-primary w-100 mt-2"
        onclick="startQRScanner('visit')"
      >
        –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è
      </button>
      <button
        class="btn btn-success w-100 mt-2"
        onclick="startQRScanner('payment')"
      >
        –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã
      </button>
      <div id="qrScanner" class="qr-container" style="display: none">
        <video id="qrVideo"></video>
        <canvas id="qrCanvas"></canvas>
        <button class="btn btn-danger w-100 mt-2" onclick="stopQRScanner()">
          –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        </button>
        <div id="debugInfo"></div>
      </div>
      <input
        type="text"
        class="form-control mt-2"
        id="manualVisitKey"
        placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é"
      />
      <button class="btn btn-primary w-100 mt-2" onclick="addVisitFromManual()">
        –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
      </button>
      <input
        type="text"
        class="form-control mt-2"
        id="manualPaymentKey"
        placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –æ–ø–ª–∞—Ç—ã –≤—Ä—É—á–Ω—É—é"
      />
      <button
        class="btn btn-success w-100 mt-2"
        onclick="confirmPaymentManual()"
      >
        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –≤—Ä—É—á–Ω—É—é
      </button>
      <p><strong>–¢–µ–∫—É—â–∏–π —Å—á—ë—Ç:</strong> <span id="adminVisits">0</span></p>
      <input
        type="text"
        class="form-control mt-2"
        id="pushMessage"
        placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
      />
      <button class="btn btn-warning w-100 mt-2" onclick="sendPushNotification()">
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º
      </button>
      <button class="btn btn-info w-100 mt-2" onclick="showAllUsers()">
        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      </button>
      <button class="btn btn-secondary w-100 mt-2" onclick="exportToExcel()">
        –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
      </button>
      <button
        class="btn btn-danger w-100 mt-2"
        id="removeVisitBtn"
        onclick="removeVisit()"
        disabled
      >
        –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ
      </button>
      <button class="btn btn-info w-100 mt-2" onclick="showErrorLog()">
        –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥ –æ—à–∏–±–æ–∫
      </button>
      <div id="usersTable" class="mt-3" style="overflow-x: auto"></div>
      <h4 class="black-label mt-3">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h4>
      <input
        type="file"
        class="form-control mt-2"
        id="productImage"
        accept="image/*"
      />
      <input
        type="text"
        class="form-control mt-2"
        id="productName"
        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
      />
      <textarea
        class="form-control mt-2"
        id="productDescription"
        placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
      ></textarea>
      <input
        type="number"
        class="form-control mt-2"
        id="productPriceRegular"
        placeholder="–¶–µ–Ω–∞ (–±–µ–∑ –∫–∞—Ä—Ç—ã)"
      />
      <input
        type="number"
        class="form-control mt-2"
        id="productPriceCard"
        placeholder="–¶–µ–Ω–∞ (—Å –∫–∞—Ä—Ç–æ–π)"
      />
      <button class="btn btn-primary w-100 mt-2" onclick="addProduct()">
        –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
      </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è: –≤—Ö–æ–¥ -->
    <div id="visitorLoginSection" class="content-section">
      <h3 class="black-label">–í—Ö–æ–¥ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</h3>
      <input
        type="text"
        class="form-control"
        id="visitorLoginInput"
        placeholder="–õ–æ–≥–∏–Ω"
      />
      <input
        type="password"
        class="form-control mt-2"
        id="visitorPasswordInput"
        placeholder="–ü–∞—Ä–æ–ª—å"
      />
      <div class="form-check mt-2">
        <input type="checkbox" class="form-check-input" id="rememberMe" />
        <label class="form-check-label" for="rememberMe"
          >–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label
        >
      </div>
      <button class="btn btn-primary w-100 mt-2" onclick="visitorLogin()">
        –í–æ–π—Ç–∏
      </button>
      <button class="btn btn-secondary w-100 mt-2" onclick="showRegister()">
        –ö—É–ø–∏—Ç—å –∫–ª—É–±–Ω—É—é –∫–∞—Ä—Ç—É
      </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="registerSection" class="content-section">
      <h3 class="black-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª—É–±–Ω–æ–π –∫–∞—Ä—Ç—ã</h3>
      <input
        type="text"
        class="form-control"
        id="childFullName"
        placeholder="–§–ò–û —Ä–µ–±—ë–Ω–∫–∞"
      />
      <input
        type="text"
        class="form-control mt-2"
        id="parentFullName"
        placeholder="–§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è"
      />
      <input type="date" class="form-control mt-2" id="childBirthDate" />
      <input
        type="tel"
        class="form-control mt-2"
        id="parentPhone"
        placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
      />
      <input
        type="text"
        class="form-control mt-2"
        id="newLogin"
        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω"
      />
      <input
        type="password"
        class="form-control mt-2"
        id="newPassword"
        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å"
      />
      <button class="btn btn-primary w-100 mt-2" onclick="registerCard()">
        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
      </button>
      <p class="mt-2"><strong>QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã:</strong></p>
      <div id="paymentQRCode" class="qr-container"></div>
      <p>
        <small>–ö–ª—é—á –æ–ø–ª–∞—Ç—ã: <span id="paymentKeyDisplay"></span></small>
      </p>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è: –∫–∞—Ä—Ç–∞ -->
    <div id="clubCardSection" class="content-section">
      <h3 class="black-label">–ö–ª—É–±–Ω–∞—è –∫–∞—Ä—Ç–∞</h3>
      <p><strong>–†–µ–±—ë–Ω–æ–∫:</strong> <span id="cardChildName"></span></p>
      <p><strong>–ü–æ—Å–µ—â–µ–Ω–∏–π:</strong> <span id="visits">0</span></p>
      <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status">0/5 –¥–æ –±–æ–Ω—É—Å–∞</span></p>
      <p><strong>QR-–∫–æ–¥ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è:</strong></p>
      <div id="visitQRCode" class="qr-container"></div>
      <p>
        <small>–ö–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è: <span id="visitKeyDisplay"></span></small>
      </p>
      <button class="btn btn-danger w-100 mt-2" onclick="deleteAccount()">
        –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
      </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ -->
    <div id="catalogSection" class="content-section">
      <h3 class="black-label">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h3>
      <div id="catalogList"></div>
    </div>
  </div>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
  <nav class="navbar-bottom">
    <button
      class="btn"
      onclick="showSection('visitorLoginSection')"
      title="–°–µ–º—å—è"
    >
      <i class="fas fa-users"></i>
    </button>
    <button class="btn" onclick="showSection('catalogSection')" title="–ö–∞—Ç–∞–ª–æ–≥">
      <i class="fas fa-shopping-cart"></i>
    </button>
    <button
      class="btn"
      onclick="showSection('broadcastSection')"
      title="–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è"
    >
      <i class="fas fa-video"></i>
    </button>
    <button
      class="btn"
      onclick="showSection('adminLoginSection')"
      title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
    >
      <i class="fas fa-user-tie"></i>
    </button>
  </nav>

  <script>
    /***************************************
     * 1) –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE
     ***************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCHzIpWUU0BOpZMl0eNxwIn_GdqSkIInHk",
      authDomain: "pesochnyeostrova.firebaseapp.com",
      projectId: "pesochnyeostrova",
      storageBucket: "pesochnyeostrova.firebasestorage.app",
      messagingSenderId: "632919679127",
      appId: "1:632919679127:web:564b427bca7f0052a289d2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // –ü–∞—Ä–æ–ª–∏ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    const ADMIN_PASSWORDS = ["SandMaster23", "IslandGuard27", "PesokKing99"];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–∫—ç—à –∏–∑ Firestore)
    let visitors = {};      // –∫–ª—é—á = childName, –∑–Ω–∞—á–µ–Ω–∏–µ = –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
    let products = [];      // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    let subscriptions = []; // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    let errorLog = [];      // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    let lastScannedChild = null; // –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è

    /*******************************************************
     * 2) –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –î–ê–ù–ù–´–• –ò–ó FIRESTORE –ü–†–ò –°–¢–ê–†–¢–ï
     *******************************************************/
    async function loadData() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        const visitorsSnapshot = await db.collection("visitors").get();
        visitorsSnapshot.forEach((doc) => {
          visitors[doc.id] = doc.data();
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
        const productsSnapshot = await db.collection("products").get();
        products = productsSnapshot.docs.map((doc) => doc.data());

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø—É—à
        const subscriptionsSnapshot = await db.collection("subscriptions").get();
        subscriptions = subscriptionsSnapshot.docs.map((doc) => doc.data());

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥ –æ—à–∏–±–æ–∫
        const errorsSnapshot = await db.collection("errorLog").get();
        errorLog = errorsSnapshot.docs.map((doc) => doc.data());

        displayCatalog();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firestore:", err);
      }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadData();

    /*******************************************************
     * 3) –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–ï–ö–¶–ò–ô ( welcomeSection / admin / ...)
     *******************************************************/
    function showSection(sectionId) {
      document.querySelectorAll(".content-section").forEach((section) => {
        section.classList.remove("active");
      });
      document.getElementById(sectionId).classList.add("active");
      window.scrollTo(0, 0);
    }

    // –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å"
    // (–ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏–º–µ–Ω–Ω–æ —ç—Ç—É —Å–µ–∫—Ü–∏—é –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ä–∞–∑—É)
    // showSection('welcomeSection');

    /*******************************************************
     * 4) –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –õ–û–ì–ò–ù–ê, –ï–°–õ–ò –ù–£–ñ–ù–û
     *******************************************************/
    window.onload = function () {
      let savedLogin = localStorage.getItem("savedLogin");
      let savedPassword = localStorage.getItem("savedPassword");
      if (savedLogin && savedPassword) {
        document.getElementById("visitorLoginInput").value = savedLogin;
        document.getElementById("visitorPasswordInput").value = savedPassword;
        document.getElementById("rememberMe").checked = true;
      }
    };

    /*******************************************************
     * 5) –õ–û–ì–ò–ö–ê –í–•–û–î–ê –í –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨
     *******************************************************/
    function adminLogin() {
      let password = document.getElementById("adminPassword").value;
      if (ADMIN_PASSWORDS.includes(password)) {
        showSection("adminPanelSection");
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
      }
    }

    /*******************************************************
     * 6) –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–û–°–ï–¢–ò–¢–ï–õ–Ø (–ö–ê–†–¢–´)
     *******************************************************/
    function generateKey(prefix, childName) {
      const time = Date.now().toString(36);
      return `${prefix}-${childName.replace(/\s+/g, "").slice(0, 5)}-${time}`.toUpperCase();
    }

    function generateAdminKey(childFullName, parentFullName, birthDate) {
      let childParts = childFullName.trim().split(/\s+/);
      let initials = "";
      if (childParts.length === 3) {
        initials = childParts[0][0] + childParts[1][0] + childParts[2][0];
      } else if (childParts.length === 2) {
        initials = childParts[0][0] + childParts[1][0];
      } else {
        initials = childParts[0][0];
      }
      let parentInitial = parentFullName.trim()[0];
      let birthYear = new Date(birthDate).getFullYear();
      return `${initials}${parentInitial}${birthYear}`;
    }

    async function generateVisitQR(childName) {
      let visitKey = generateKey("VISIT", childName);
      let visitKeyExpiration = Date.now() + 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
      // –û–±–Ω–æ–≤–ª—è–µ–º Firestore
      await db.collection("visitors").doc(childName).update({
        visitKey: visitKey,
        visitKeyExpiration: visitKeyExpiration,
      });
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
      visitors[childName].visitKey = visitKey;
      visitors[childName].visitKeyExpiration = visitKeyExpiration;

      let qrCodeData = `visit:${visitKey}`;
      QRCode.toCanvas(
        document.createElement("canvas"),
        qrCodeData,
        { width: 150 },
        function (error, canvas) {
          if (error) console.error(error);
          document.getElementById("visitQRCode").innerHTML = "";
          document.getElementById("visitQRCode").appendChild(canvas);
        }
      );
      document.getElementById("visitKeyDisplay").innerText = visitKey;
      return visitKey;
    }

    async function generatePaymentQR(childName) {
      let paymentKey = generateKey("PAY", childName);
      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firestore
      await db.collection("visitors").doc(childName).update({
        paymentKey: paymentKey,
      });
      visitors[childName].paymentKey = paymentKey;

      let qrCodeData = `payment:${paymentKey}`;
      QRCode.toCanvas(
        document.createElement("canvas"),
        qrCodeData,
        { width: 150 },
        function (error, canvas) {
          if (error) console.error(error);
          document.getElementById("paymentQRCode").innerHTML = "";
          document.getElementById("paymentQRCode").appendChild(canvas);
        }
      );
      document.getElementById("paymentKeyDisplay").innerText = paymentKey;
      return paymentKey;
    }

    async function registerCard() {
      let childName = document.getElementById("childFullName").value.trim();
      let parentName = document.getElementById("parentFullName").value.trim();
      let birthDate = document.getElementById("childBirthDate").value;
      let phone = document.getElementById("parentPhone").value.trim();
      let login = document.getElementById("newLogin").value.trim();
      let password = document.getElementById("newPassword").value.trim();

      if (!childName || !parentName || !birthDate || !phone || !login || !password) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        return;
      }
      if (password.length < 6) {
        alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!");
        return;
      }
      if (!/^\+?\d{10,12}$/.test(phone)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (10-12 —Ü–∏—Ñ—Ä)!");
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Firestore, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞
      let docRef = db.collection("visitors").doc(childName);
      let docSnap = await docRef.get();
      if (docSnap.exists) {
        alert("–≠—Ç–æ—Ç —Ä–µ–±—ë–Ω–æ–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
        return;
      }

      let hashedPassword = CryptoJS.SHA256(password).toString();
      let adminKey = generateAdminKey(childName, parentName, birthDate);
      let registrationDate = new Date().toISOString().split("T")[0];

      let newVisitor = {
        login: login,
        password: hashedPassword,
        parentName: parentName,
        birthDate: birthDate,
        phone: phone,
        visits: 0,
        registered: true,
        paid: false,
        adminKey: adminKey,
        registrationDate: registrationDate,
        visitKey: "",
        paymentKey: "",
        visitKeyExpiration: 0,
      };

      // –°–æ–∑–¥–∞—ë–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ Firestore
      await docRef.set(newVisitor);
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é
      visitors[childName] = newVisitor;

      // –ì–µ–Ω–µ—Ä–∏–º QR-–∫–æ–¥—ã
      let visitKey = await generateVisitQR(childName);
      let paymentKey = await generatePaymentQR(childName);

      subscribeToPush(childName);
      alert(
        `–ö–∞—Ä—Ç–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!\n–ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–ª—é—á: ${paymentKey}).\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è (–∫–æ–¥: ${visitKey}).\n–ê–¥–º–∏–Ω-–∫–ª—é—á: ${adminKey} (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è).`
      );
    }

    /*******************************************************
     * 7) –í–•–û–î –ü–û–°–ï–¢–ò–¢–ï–õ–Ø
     *******************************************************/
    async function visitorLogin() {
      let login = document.getElementById("visitorLoginInput").value;
      let password = document.getElementById("visitorPasswordInput").value;
      let rememberMe = document.getElementById("rememberMe").checked;
      let hashedPassword = CryptoJS.SHA256(password).toString();

      // –ò—â–µ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –ø–æ login & password
      let snapshot = await db
        .collection("visitors")
        .where("login", "==", login)
        .where("password", "==", hashedPassword)
        .get();

      if (!snapshot.empty) {
        let doc = snapshot.docs[0];
        let childName = doc.id;
        let user = doc.data();

        if (user.registered) {
          if (user.paid) {
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (rememberMe) {
              localStorage.setItem("savedLogin", login);
              localStorage.setItem("savedPassword", password);
            } else {
              localStorage.removeItem("savedLogin");
              localStorage.removeItem("savedPassword");
            }
            showSection("clubCardSection");
            document.getElementById("cardChildName").innerText = childName;

            // –ï—Å–ª–∏ visitKey –Ω–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω ‚Äî –≥–µ–Ω–µ—Ä–∏–º –∑–∞–Ω–æ–≤–æ
            if (!user.visitKey || Date.now() > user.visitKeyExpiration) {
              await generateVisitQR(childName);
            } else {
              // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π QR
              let qrCodeData = `visit:${user.visitKey}`;
              QRCode.toCanvas(
                document.createElement("canvas"),
                qrCodeData,
                { width: 150 },
                function (error, canvas) {
                  if (error) console.error(error);
                  document.getElementById("visitQRCode").innerHTML = "";
                  document.getElementById("visitQRCode").appendChild(canvas);
                }
              );
              document.getElementById("visitKeyDisplay").innerText = user.visitKey;
            }
            updateCard(childName, user.visits);
          } else {
            alert("–ö–∞—Ä—Ç–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞. –ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.");
          }
        }
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!");
      }
    }

    function updateCard(childName, visitsCount) {
      // –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ visitsCount, –±–µ—Ä—ë–º –∏–∑ visitors[childName]
      if (typeof visitsCount === "undefined") {
        visitsCount = visitors[childName].visits;
      }
      let statusText =
        visitsCount < 5 ? `${visitsCount}/5 –¥–æ –±–æ–Ω—É—Å–∞` : "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ (30 –º–∏–Ω)";
      document.getElementById("visits").innerText = visitsCount;
      document.getElementById("status").innerText = statusText;

      // –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ >= 6 ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
      if (visitsCount >= 6) {
        db.collection("visitors").doc(childName).update({ visits: 0 });
        visitors[childName].visits = 0;
        alert("–°—á—ë—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω! –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ.");
        updateCard(childName, 0);
      }
    }

    /*******************************************************
     * 8) –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï QR-–ö–û–î–ê (JSQR)
     *******************************************************/
    let video = null;
    let scanType = "visit";
    function startQRScanner(type) {
      scanType = type;
      const qrScanner = document.getElementById("qrScanner");
      const qrVideo = document.getElementById("qrVideo");
      const qrCanvas = document.getElementById("qrCanvas");
      const debugInfo = document.getElementById("debugInfo");
      qrScanner.style.display = "block";
      debugInfo.innerText = "–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...";

      navigator.mediaDevices
        .enumerateDevices()
        .then((devices) => {
          const videoDevices = devices.filter((d) => d.kind === "videoinput");
          if (videoDevices.length === 0) {
            alert("–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä.");
            qrScanner.style.display = "none";
            return;
          }

          if (!video) {
            video = qrVideo;
            navigator.mediaDevices
              .getUserMedia({
                video: { facingMode: { ideal: "environment" } },
              })
              .then((stream) => {
                video.srcObject = stream;
                video.play();
                debugInfo.innerText = `–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ${
                  type === "visit" ? "–ø–æ—Å–µ—â–µ–Ω–∏—è" : "–æ–ø–ª–∞—Ç—ã"
                }...`;
                scanQRCode();
              })
              .catch((err) => {
                debugInfo.innerText = `–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${err.message}`;
                logError(`–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${err.message}`);
                alert(
                  `–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: ${err.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`
                );
                qrScanner.style.display = "none";
              });
          }
        })
        .catch((err) => {
          debugInfo.innerText = `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${err.message}`;
          logError(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${err.message}`);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: " + err.message);
          qrScanner.style.display = "none";
        });

      function scanQRCode() {
        if (!video || !video.srcObject) {
          debugInfo.innerText = "–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.";
          return;
        }
        const canvasContext = qrCanvas.getContext("2d");
        qrCanvas.width = video.videoWidth || 300;
        qrCanvas.height = video.videoHeight || 300;
        canvasContext.drawImage(video, 0, 0, qrCanvas.width, qrCanvas.height);
        const imageData = canvasContext.getImageData(
          0,
          0,
          qrCanvas.width,
          qrCanvas.height
        );
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          debugInfo.innerText = `QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${code.data}`;
          const qrData = code.data;
          if (scanType === "visit" && qrData.startsWith("visit:")) {
            const visitKey = qrData.split(":")[1];
            addVisitFromQR(visitKey);
          } else if (scanType === "payment" && qrData.startsWith("payment:")) {
            const paymentKey = qrData.split(":")[1];
            confirmPaymentQR(paymentKey);
          } else {
            debugInfo.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.";
            logError(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞: ${qrData}`);
          }
          stopQRScanner();
        } else {
          debugInfo.innerText = `QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ${
            type === "visit" ? "–ø–æ—Å–µ—â–µ–Ω–∏—è" : "–æ–ø–ª–∞—Ç—ã"
          }...`;
          requestAnimationFrame(scanQRCode);
        }
      }
    }

    function stopQRScanner() {
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach((track) => track.stop());
        video.srcObject = null;
        video = null;
      }
      document.getElementById("qrScanner").style.display = "none";
      document.getElementById("debugInfo").innerText = "";
    }

    /*******************************************************
     * 9) –î–û–ë–ê–í–ò–¢–¨ –ü–û–°–ï–©–ï–ù–ò–ï (QR)
     *******************************************************/
    async function addVisitFromQR(visitKey) {
      // –ò—â–µ–º –≤ –ë–î –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º visitKey
      let snap = await db
        .collection("visitors")
        .where("visitKey", "==", visitKey)
        .get();
      if (snap.empty) {
        logError(`–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è: ${visitKey}`);
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è!");
        return;
      }

      let doc = snap.docs[0];
      let childName = doc.id;
      let userData = doc.data();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–ø–ª–∞—á–µ–Ω –ª–∏
      if (!userData.paid) {
        alert("–ö–∞—Ä—Ç–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞!");
        return;
      }
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ visitKey
      if (Date.now() > userData.visitKeyExpiration) {
        logError(`QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–ª –¥–ª—è ${childName}`);
        alert("QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–ª! –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.");
        return;
      }

      let newVisits = userData.visits + 1;
      await db.collection("visitors").doc(childName).update({
        visits: newVisits,
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
      visitors[childName].visits = newVisits;
      lastScannedChild = childName;

      document.getElementById("adminVisits").innerText = newVisits;
      document.getElementById("removeVisitBtn").disabled = false;
      alert(`–ü–æ—Å–µ—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è ${childName}!`);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π visitKey (–Ω–∞ –±—É–¥—É—â–µ–µ)
      await generateVisitQR(childName);
    }

    /*******************************************************
     * 10) –î–û–ë–ê–í–ò–¢–¨ –ü–û–°–ï–©–ï–ù–ò–ï –í–†–£–ß–ù–£–Æ
     *******************************************************/
    async function addVisitFromManual() {
      let visitKey = document.getElementById("manualVisitKey").value.trim();
      if (!visitKey) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è!");
        return;
      }

      // –ü–æ–∏—Å–∫ –≤ –ë–î
      let snap = await db
        .collection("visitors")
        .where("visitKey", "==", visitKey)
        .get();
      if (snap.empty) {
        logError(`–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è: ${visitKey}`);
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è!");
        return;
      }
      let doc = snap.docs[0];
      let childName = doc.id;
      let userData = doc.data();

      if (!userData.paid) {
        alert("–ö–∞—Ä—Ç–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞!");
        return;
      }
      if (Date.now() > userData.visitKeyExpiration) {
        logError(`–ö–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–ª –¥–ª—è ${childName}`);
        alert("–ö–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–ª! –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.");
        return;
      }

      let newVisits = userData.visits + 1;
      await db.collection("visitors").doc(childName).update({
        visits: newVisits,
      });
      visitors[childName].visits = newVisits;
      lastScannedChild = childName;

      document.getElementById("adminVisits").innerText = newVisits;
      document.getElementById("removeVisitBtn").disabled = false;
      alert(`–ü–æ—Å–µ—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è ${childName}!`);
      document.getElementById("manualVisitKey").value = "";

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π visitKey
      await generateVisitQR(childName);
    }

    /*******************************************************
     * 11) –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –û–ü–õ–ê–¢–£ (QR)
     *******************************************************/
    async function confirmPaymentQR(paymentKey) {
      let snap = await db
        .collection("visitors")
        .where("paymentKey", "==", paymentKey)
        .get();
      if (snap.empty) {
        logError(`–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã: ${paymentKey}`);
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã!");
        return;
      }
      let doc = snap.docs[0];
      let childName = doc.id;

      // –û–±–Ω–æ–≤–ª—è–µ–º paid –≤ Firestore
      await db.collection("visitors").doc(childName).update({ paid: true });
      visitors[childName].paid = true;

      alert(`–û–ø–ª–∞—Ç–∞ –¥–ª—è ${childName} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.`);
      sendPushToUser(childName, "–í–∞—à–∞ –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞!");
    }

    /*******************************************************
     * 12) –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –û–ü–õ–ê–¢–£ –í–†–£–ß–ù–£–Æ
     *******************************************************/
    async function confirmPaymentManual() {
      let paymentKey = document.getElementById("manualPaymentKey").value.trim();
      if (!paymentKey) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –æ–ø–ª–∞—Ç—ã!");
        return;
      }

      let snap = await db
        .collection("visitors")
        .where("paymentKey", "==", paymentKey)
        .get();
      if (snap.empty) {
        logError(`–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –æ–ø–ª–∞—Ç—ã: ${paymentKey}`);
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –æ–ø–ª–∞—Ç—ã!");
        return;
      }
      let doc = snap.docs[0];
      let childName = doc.id;

      await db.collection("visitors").doc(childName).update({ paid: true });
      visitors[childName].paid = true;

      alert(`–û–ø–ª–∞—Ç–∞ –¥–ª—è ${childName} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.`);
      sendPushToUser(childName, "–í–∞—à–∞ –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞!");
      document.getElementById("manualPaymentKey").value = "";
    }

    /*******************************************************
     * 13) –û–¢–ü–†–ê–í–ö–ê PUSH –û–î–ù–û–ú–£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ
     *******************************************************/
    function sendPushToUser(childName, message) {
      let subObj = subscriptions.find((s) => s.childName === childName);
      if (subObj && "serviceWorker" in navigator) {
        navigator.serviceWorker.ready
          .then((registration) => {
            registration.showNotification("–ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞", {
              body: message,
              icon: "–†–µ—Å—É—Ä—Å 1@10x.png",
            });
            console.log(`Push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${childName}: ${message}`);
          })
          .catch((err) => {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Push:", err);
            alert("Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS.");
          });
      } else {
        console.log(`Push –¥–ª—è ${childName}: ${message} (—Ç–µ—Å—Ç –±–µ–∑ HTTPS)`);
        alert(`Push –¥–ª—è ${childName}: ${message} (—Ç–µ—Å—Ç –±–µ–∑ HTTPS)`);
      }
    }

    /*******************************************************
     * 14) –£–î–ê–õ–ò–¢–¨ –ü–û–°–õ–ï–î–ù–ï–ï –ü–û–°–ï–©–ï–ù–ò–ï
     *******************************************************/
    async function removeVisit() {
      if (!lastScannedChild || !visitors[lastScannedChild]) {
        alert("–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é!");
        return;
      }

      let currentVisits = visitors[lastScannedChild].visits || 0;
      if (currentVisits > 0) {
        let newVisits = currentVisits - 1;
        // –û–±–Ω–æ–≤–ª—è–µ–º Firestore
        await db
          .collection("visitors")
          .doc(lastScannedChild)
          .update({ visits: newVisits });

        visitors[lastScannedChild].visits = newVisits;
        document.getElementById("adminVisits").innerText = newVisits;
        alert(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –¥–ª—è ${lastScannedChild} —É–¥–∞–ª–µ–Ω–æ!`);

        if (newVisits === 0) {
          document.getElementById("removeVisitBtn").disabled = true;
        }
        showAllUsers();
      } else {
        alert("–£ —ç—Ç–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ –Ω–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π!");
        document.getElementById("removeVisitBtn").disabled = true;
      }
    }

    /*******************************************************
     * 15) –ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–¢–ê–ë–õ–ò–¶–ê)
     *******************************************************/
    async function showAllUsers() {
      // –°–Ω–æ–≤–∞ –∑–∞–≥—Ä—É–∑–∏–º –∏–∑ Firestore, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      let snapshot = await db.collection("visitors").get();
      let table = `<table class='table table-striped'><tr>
        <th>–§–ò–û —Ä–µ–±—ë–Ω–∫–∞</th>
        <th>–§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è</th>
        <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
        <th>–ö–ª—é—á –æ–ø–ª–∞—Ç—ã</th>
        <th>–ö–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è</th>
        <th>–ü–æ—Å–µ—â–µ–Ω–∏–π</th>
        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
        <th>–ê–¥–º–∏–Ω-–∫–ª—é—á</th>
        <th>–õ–æ–≥–∏–Ω</th>
        <th>–ü–∞—Ä–æ–ª—å (—Ö—ç—à)</th>
      </tr>`;
      snapshot.forEach((doc) => {
        let user = doc.data();
        table += `<tr>
          <td>${doc.id}</td>
          <td>${user.parentName || ""}</td>
          <td>${user.birthDate || ""}</td>
          <td>${user.phone || ""}</td>
          <td>${user.paid ? "–î–∞" : "–ù–µ—Ç"}</td>
          <td>${user.paymentKey || ""}</td>
          <td>${user.visitKey || ""}</td>
          <td>${user.visits || 0}</td>
          <td>${user.registrationDate || ""}</td>
          <td>${user.adminKey || ""}</td>
          <td>${user.login || ""}</td>
          <td>${user.password || ""}</td>
        </tr>`;
      });
      table += "</table>";
      document.getElementById("usersTable").innerHTML = table;
    }

    /*******************************************************
     * 16) –ü–û–î–ü–ò–°–ö–ê –ù–ê PUSH
     *******************************************************/
    function subscribeToPush(childName) {
      if ("Notification" in window && "serviceWorker" in navigator) {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            navigator.serviceWorker.register("sw.js").then(async (registration) => {
              try {
                let sub = await registration.pushManager.subscribe({
                  userVisibleOnly: true,
                });
                let subData = {
                  childName: childName,
                  subscription: sub.toJSON(),
                };
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
                await db.collection("subscriptions").doc(childName).set(subData);
                subscriptions.push(subData);
              } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Push:", err);
              }
            });
          }
        });
      }
    }

    /*******************************************************
     * 17) –û–¢–ü–†–ê–í–ò–¢–¨ PUSH –í–°–ï–ú –ü–û–î–ü–ò–°–ß–ò–ö–ê–ú
     *******************************************************/
    function sendPushNotification() {
      let message = document.getElementById("pushMessage").value;
      if (!message) {
        alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!");
        return;
      }
      // –ù–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ push ‚Äì –ø—Ä–æ—Å—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ–º
      subscriptions.forEach((subObj) => {
        let childName = subObj.childName;
        navigator.serviceWorker.ready
          .then((registration) => {
            registration.showNotification("–ü–µ—Å–æ—á–Ω—ã–µ –û—Å—Ç—Ä–æ–≤–∞", {
              body: message,
              icon: "–†–µ—Å—É—Ä—Å 1@10x.png",
            });
            console.log(`Push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è ${childName}: ${message}`);
          })
          .catch((err) => {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Push:", err);
            alert("Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS.");
          });
      });
      document.getElementById("pushMessage").value = "";
      alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (—Ç–µ—Å—Ç –±–µ–∑ HTTPS)");
    }

    /*******************************************************
     * 18) –£–î–ê–õ–ï–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–ê –ü–û–°–ï–¢–ò–¢–ï–õ–ï–ú
     *******************************************************/
    async function deleteAccount() {
      let childName = document.getElementById("cardChildName").innerText;
      if (!childName) return;
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) {
        await db.collection("visitors").doc(childName).delete();
        delete visitors[childName];
        alert("–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω!");
        showSection("visitorLoginSection");
      }
    }

    /*******************************************************
     * 19) –≠–ö–°–ü–û–†–¢ –í EXCEL
     *******************************************************/
    async function exportToExcel() {
      let snapshot = await db.collection("visitors").get();
      let data = [];
      let totalVisits = 0;
      snapshot.forEach((doc) => {
        let user = doc.data();
        totalVisits += user.visits || 0;
        data.push([
          doc.id,
          user.parentName || "",
          user.birthDate || "",
          user.phone || "",
          user.paid ? "–î–∞" : "–ù–µ—Ç",
          user.paymentKey || "",
          user.visitKey || "",
          user.visits || 0,
          user.registrationDate || "",
          user.adminKey || "",
          user.login || "",
          user.password || "",
        ]);
      });
      data.push([
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "–ò—Ç–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π:",
        totalVisits,
        "",
        "",
        "",
      ]);
      let ws = XLSX.utils.aoa_to_sheet([
        [
          "–§–ò–û —Ä–µ–±—ë–Ω–∫–∞",
          "–§–ò–û —Ä–æ–¥–∏—Ç–µ–ª—è",
          "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è",
          "–¢–µ–ª–µ—Ñ–æ–Ω",
          "–û–ø–ª–∞—á–µ–Ω–æ",
          "–ö–ª—é—á –æ–ø–ª–∞—Ç—ã",
          "–ö–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è",
          "–ü–æ—Å–µ—â–µ–Ω–∏–π",
          "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
          "–ê–¥–º–∏–Ω-–∫–ª—é—á",
          "–õ–æ–≥–∏–Ω",
          "–ü–∞—Ä–æ–ª—å (—Ö—ç—à)",
        ],
        ...data,
      ]);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏");
      XLSX.writeFile(wb, "Visitors_P–µ—Å–æ—á–Ω—ã–µ_–û—Å—Ç—Ä–æ–≤–∞.xlsx", {
        bookSST: true,
        type: "binary",
      });
    }

    /*******************************************************
     * 20) –õ–û–ì –û–®–ò–ë–û–ö
     *******************************************************/
    async function logError(message) {
      let errorEntry = {
        date: new Date().toISOString(),
        message: message,
      };
      errorLog.push(errorEntry);
      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firestore
      await db.collection("errorLog").doc(Date.now().toString()).set(errorEntry);
    }

    function showErrorLog() {
      let logDiv = document.createElement("div");
      logDiv.innerHTML =
        '<h4 class="black-label">–õ–æ–≥ –æ—à–∏–±–æ–∫</h4>' +
        errorLog
          .map((e) => `<p>${e.date}: ${e.message}</p>`)
          .join("");
      document.getElementById("adminPanelSection").appendChild(logDiv);
    }

    /*******************************************************
     * 21) –ö–ê–¢–ê–õ–û–ì –¢–û–í–ê–†–û–í
     *******************************************************/
    function displayCatalog() {
      let list = "";
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–≤—ë–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥–º–∏–Ω-–ø–∞—Ä–æ–ª—å,
      // —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å"
      let adminInput = document.getElementById("adminPassword");
      let isAdmin = adminInput && ADMIN_PASSWORDS.includes(adminInput.value);

      products.forEach((product, index) => {
        list += `<div class="catalog-item mt-3">
          <img src="${product.image}" alt="${product.name}">
          <p><strong>${product.name}</strong></p>
          <p>–¶–µ–Ω–∞ (–±–µ–∑ –∫–∞—Ä—Ç—ã): ${product.priceRegular} —Ä—É–±.</p>
          <p>–¶–µ–Ω–∞ (—Å –∫–∞—Ä—Ç–æ–π): ${product.priceCard} —Ä—É–±.</p>
          <button class="btn btn-success" onclick="alert('–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –ø–æ–∫—É–ø–∫–∏!')">–ö—É–ø–∏—Ç—å</button>`;
        if (isAdmin) {
          list += `<button class="btn btn-danger mt-1" onclick="deleteProduct('${product.name}')">–£–¥–∞–ª–∏—Ç—å</button>`;
        }
        list += `</div>`;
      });
      document.getElementById("catalogList").innerHTML = list;
    }

    async function addProduct() {
      let file = document.getElementById("productImage").files[0];
      let name = document.getElementById("productName").value;
      let description = document.getElementById("productDescription").value;
      let priceRegular = document.getElementById("productPriceRegular").value;
      let priceCard = document.getElementById("productPriceCard").value;

      if (file && name && description && priceRegular && priceCard) {
        let reader = new FileReader();
        reader.onload = async function (e) {
          let productData = {
            image: e.target.result,
            name: name,
            description: description,
            priceRegular: priceRegular,
            priceCard: priceCard,
          };
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
          await db.collection("products").doc(name).set(productData);
          // –í –ø–∞–º—è—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ–º
          products.push(productData);

          displayCatalog();

          // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
          document.getElementById("productImage").value = "";
          document.getElementById("productName").value = "";
          document.getElementById("productDescription").value = "";
          document.getElementById("productPriceRegular").value = "";
          document.getElementById("productPriceCard").value = "";
        };
        reader.readAsDataURL(file);
      } else {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
      }
    }

    async function deleteProduct(productName) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å "${productName}" –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞?`)) {
        // –£–¥–∞–ª—è–µ–º –∏–∑ Firestore
        await db.collection("products").doc(productName).delete();
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        products = products.filter((p) => p.name !== productName);
        displayCatalog();
      }
    }

    /*******************************************************
     * 22) –ü–†–û–ö–†–£–¢–ö–ê –°–¢–†–ê–ù–ò–¶–´ –ü–†–ò –§–û–ö–£–°–ï –ù–ê INPUT (–ú–û–ë. –£–°–¢–†–û–ô–°–¢–í–ê)
     *******************************************************/
    document.querySelectorAll("input, textarea").forEach((input) => {
      input.addEventListener("focus", () => {
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: "smooth" });
          input.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 100);
      });
    });

    /*******************************************************
     * 23) REG SERVICE WORKER (–î–õ–Ø PUSH)
     *******************************************************/
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("sw.js")
        .catch((err) =>
          console.error("Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:", err)
        );
    }
  </script>
</body>
</html>
